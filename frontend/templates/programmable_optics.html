<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenOptics - Programmable Optics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .device-card {
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .parameter-slider {
            width: 100%;
        }
        .card-header-tabs {
            margin-right: 0;
            margin-bottom: -0.5rem;
            margin-left: 0;
        }
        .nav-tabs .nav-link {
            margin-bottom: 0;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .metrics-card {
            height: 100%;
        }
        .controller-chip {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #cfe2ff;
            border: 1px solid #9ec5fe;
        }
        .parameter-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .performance-chart {
            height: 250px;
            width: 100%;
        }
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-braces"></i> OpenOptics
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/network">Network</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/programmable-optics">Programmable Optics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/simulation">Simulation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">Analytics</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/profile">
                            <i class="bi bi-person-circle"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Devices</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="device-list">
                            <!-- Devices will be populated here -->
                            <div class="text-center my-4 text-secondary">
                                <i class="bi bi-router fs-2"></i>
                                <p>Loading devices...</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary w-100 mt-3" id="refresh-devices-btn">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Devices
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Active Controllers</h5>
                    </div>
                    <div class="card-body" id="controllers-container">
                        <!-- Controllers will be populated here -->
                        <div class="text-center my-4 text-secondary">
                            <i class="bi bi-toggles fs-2"></i>
                            <p>No active controllers</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="card mb-4" id="device-details-card" style="display: none;">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="device-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#parameters-tab">Parameters</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#simulation-tab">Simulation</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#adaptive-control-tab">Adaptive Control</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#monitoring-tab">Monitoring</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Parameters Tab -->
                            <div class="tab-pane fade show active" id="parameters-tab">
                                <div class="row mb-3">
                                    <div class="col-sm-6">
                                        <h5 id="device-name">Device Name</h5>
                                        <p id="device-description" class="text-muted">Device description</p>
                                    </div>
                                    <div class="col-sm-6 text-end">
                                        <span class="badge bg-primary" id="device-type">Type</span>
                                        <span class="badge bg-success" id="device-status">Status</span>
                                    </div>
                                </div>
                                
                                <div id="parameters-container">
                                    <!-- Parameters will be populated here -->
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-outline-secondary" id="reset-parameters-btn">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                                    </button>
                                    <button class="btn btn-primary" id="apply-parameters-btn">
                                        <i class="bi bi-check-lg"></i> Apply Changes
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Simulation Tab -->
                            <div class="tab-pane fade" id="simulation-tab">
                                <h5>Performance Simulation</h5>
                                <p class="text-muted">Simulate device performance with different parameters.</p>
                                
                                <div class="row">
                                    <div class="col-md-5">
                                        <div id="simulation-parameters">
                                            <!-- Simulation parameters will be populated here -->
                                        </div>
                                        
                                        <button class="btn btn-primary mt-3" id="run-simulation-btn">
                                            <i class="bi bi-play-fill"></i> Run Simulation
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-7">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Simulation Results</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="simulation-results" style="display: none;">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <div class="card metrics-card">
                                                                <div class="card-body">
                                                                    <h6 class="card-subtitle text-muted mb-2">SNR</h6>
                                                                    <h3 id="sim-snr">0 dB</h3>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <div class="card metrics-card">
                                                                <div class="card-body">
                                                                    <h6 class="card-subtitle text-muted mb-2">BER</h6>
                                                                    <h3 id="sim-ber">0</h3>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <div class="card metrics-card">
                                                                <div class="card-body">
                                                                    <h6 class="card-subtitle text-muted mb-2">Data Rate</h6>
                                                                    <h3 id="sim-data-rate">0 Gbps</h3>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <div class="card metrics-card">
                                                                <div class="card-body">
                                                                    <h6 class="card-subtitle text-muted mb-2">Reach</h6>
                                                                    <h3 id="sim-reach">0 km</h3>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div id="simulation-placeholder" class="text-center my-4 text-secondary">
                                                    <i class="bi bi-graph-up fs-2"></i>
                                                    <p>Run a simulation to see results</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Adaptive Control Tab -->
                            <div class="tab-pane fade" id="adaptive-control-tab">
                                <h5>Adaptive Controllers</h5>
                                <p class="text-muted">Configure autonomous controllers to optimize device parameters.</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">SNR Optimizer</h6>
                                            </div>
                                            <div class="card-body">
                                                <p>Automatically adjusts parameters to maximize signal-to-noise ratio.</p>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Update Interval (seconds)</label>
                                                    <input type="range" class="form-range" id="snr-interval" min="10" max="300" step="10" value="60">
                                                    <div class="parameter-label">
                                                        <small>10s</small>
                                                        <small id="snr-interval-value">60s</small>
                                                        <small>300s</small>
                                                    </div>
                                                </div>
                                                
                                                <button class="btn btn-primary w-100" id="start-snr-optimizer">
                                                    <i class="bi bi-play-fill"></i> Start SNR Optimizer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Modulation Adaptor</h6>
                                            </div>
                                            <div class="card-body">
                                                <p>Dynamically adapts modulation format based on link quality.</p>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Update Interval (seconds)</label>
                                                    <input type="range" class="form-range" id="mod-interval" min="30" max="600" step="30" value="300">
                                                    <div class="parameter-label">
                                                        <small>30s</small>
                                                        <small id="mod-interval-value">300s</small>
                                                        <small>600s</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">SNR Margin (dB)</label>
                                                    <input type="range" class="form-range" id="mod-margin" min="1" max="6" step="0.5" value="3">
                                                    <div class="parameter-label">
                                                        <small>1 dB</small>
                                                        <small id="mod-margin-value">3 dB</small>
                                                        <small>6 dB</small>
                                                    </div>
                                                </div>
                                                
                                                <button class="btn btn-primary w-100" id="start-mod-adaptor">
                                                    <i class="bi bi-play-fill"></i> Start Modulation Adaptor
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Power Optimizer</h6>
                                            </div>
                                            <div class="card-body">
                                                <p>Optimizes power consumption while maintaining performance.</p>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Update Interval (seconds)</label>
                                                    <input type="range" class="form-range" id="power-interval" min="30" max="300" step="30" value="120">
                                                    <div class="parameter-label">
                                                        <small>30s</small>
                                                        <small id="power-interval-value">120s</small>
                                                        <small>300s</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Minimum SNR (dB)</label>
                                                    <input type="range" class="form-range" id="min-snr" min="10" max="25" step="1" value="15">
                                                    <div class="parameter-label">
                                                        <small>10 dB</small>
                                                        <small id="min-snr-value">15 dB</small>
                                                        <small>25 dB</small>
                                                    </div>
                                                </div>
                                                
                                                <button class="btn btn-primary w-100" id="start-power-optimizer">
                                                    <i class="bi bi-play-fill"></i> Start Power Optimizer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Monitoring Tab -->
                            <div class="tab-pane fade" id="monitoring-tab">
                                <h5>Performance Monitoring</h5>
                                <p class="text-muted">Real-time metrics and performance history.</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Current Metrics</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-subtitle text-muted mb-1">SNR</h6>
                                                                <h4 id="current-snr">-- dB</h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-subtitle text-muted mb-1">BER</h6>
                                                                <h4 id="current-ber">--</h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-subtitle text-muted mb-1">Data Rate</h6>
                                                                <h4 id="current-data-rate">-- Gbps</h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card border-0 bg-light">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-subtitle text-muted mb-1">Power</h6>
                                                                <h4 id="current-power">-- dBm</h4>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button class="btn btn-outline-primary w-100 mt-2" id="refresh-metrics-btn">
                                                    <i class="bi bi-arrow-repeat"></i> Refresh Metrics
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Parameter History</h6>
                                            </div>
                                            <div class="card-body">
                                                <select class="form-select mb-3" id="parameter-history-select">
                                                    <option value="tx_power">Transmit Power</option>
                                                    <option value="snr">SNR</option>
                                                    <option value="ber">BER</option>
                                                    <option value="data_rate">Data Rate</option>
                                                </select>
                                                
                                                <div class="chart-container">
                                                    <canvas id="parameter-history-chart" class="performance-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Performance Trends</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="performance-trends-chart" class="performance-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="welcome-card" class="card">
                    <div class="card-body text-center p-5">
                        <i class="bi bi-cpu-fill text-primary" style="font-size: 4rem;"></i>
                        <h3 class="mt-4 mb-3">Programmable Optics Controller</h3>
                        <p class="text-muted mb-4">Select a device from the left panel to configure parameters, run simulations, and set up adaptive controllers.</p>
                        <button class="btn btn-outline-primary" id="scan-network-btn">
                            <i class="bi bi-search"></i> Scan Network for Devices
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Sweep Modal -->
    <div class="modal fade" id="parameter-sweep-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Parameter Sweep</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Parameter to Sweep</label>
                                <select class="form-select" id="sweep-parameter-select">
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Range</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sweep-min" placeholder="Min">
                                    <span class="input-group-text">to</span>
                                    <input type="number" class="form-control" id="sweep-max" placeholder="Max">
                                    <span class="input-group-text">step</span>
                                    <input type="number" class="form-control" id="sweep-step" placeholder="Step">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container mb-3" style="height: 300px;">
                        <canvas id="sweep-results-chart"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="run-sweep-btn">Run Sweep</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Current device state
        let currentDeviceId = null;
        let currentDevice = null;
        let deviceParameters = {};
        let modifiedParameters = {};
        let performanceHistory = {
            timestamps: [],
            tx_power: [],
            snr: [],
            ber: [],
            data_rate: []
        };
        
        // Charts
        let parameterHistoryChart;
        let performanceTrendsChart;
        let sweepResultsChart;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch devices
            fetchDevices();
            
            // Initialize charts
            initializeCharts();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        function formatParameterName(key) {
            // Converts snake_case or camelCase to Title Case
            const withSpaces = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1');
            return withSpaces.replace(/\b\w/g, char => char.toUpperCase()).trim();
        }

        function showError(message) {
            // Basic error display using alert. In a real app, use a dedicated UI element.
            console.error("Error: ", message);
            alert("Error: " + message);
        }

        function fetchDevices() {
            fetch('/api/network/programmable/devices')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        populateDeviceList(data.devices);
                    } else {
                        showError('Failed to load devices');
                    }
                })
                .catch(error => {
                    console.error('Error fetching devices:', error);
                    showError('Failed to connect to server');
                });
        }
        
        function populateDeviceList(devices) {
            const deviceList = document.getElementById('device-list');
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <div class="text-center my-4 text-secondary">
                        <i class="bi bi-exclamation-circle fs-2"></i>
                        <p>No devices found</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                let statusClass = 'bg-success';
                if (device.status === 'warning') {
                    statusClass = 'bg-warning';
                } else if (device.status === 'error') {
                    statusClass = 'bg-danger';
                }
                
                html += `
                    <a href="#" class="list-group-item list-group-item-action device-item" data-device-id="${device.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1">${device.name}</h6>
                            <span class="badge ${statusClass}">${device.status}</span>
                        </div>
                        <p class="mb-1 text-muted small">${device.type}</p>
                    </a>
                `;
            });
            
            deviceList.innerHTML = html;
            
            // Add click event for device selection
            document.querySelectorAll('.device-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const deviceId = this.getAttribute('data-device-id');
                    selectDevice(deviceId);
                });
            });
        }
        
        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            
            // Highlight selected device
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.device-item[data-device-id="${deviceId}"]`).classList.add('active');
            
            // Fetch device details
            fetch(`/api/network/programmable/device/${deviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentDevice = data.device;
                        displayDeviceDetails(data.device);
                    } else {
                        showError('Failed to load device details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching device details:', error);
                    showError('Failed to connect to server');
                });
            
            // Show device details card and hide welcome card
            document.getElementById('welcome-card').style.display = 'none';
            document.getElementById('device-details-card').style.display = 'block';
        }
        
        function displayDeviceDetails(device) {
            // Update device info
            document.getElementById('device-name').textContent = device.name;
            document.getElementById('device-description').textContent = device.description || '';
            document.getElementById('device-type').textContent = device.type;
            document.getElementById('device-status').textContent = device.status;
            
            // Set status badge color
            const statusBadge = document.getElementById('device-status');
            statusBadge.className = 'badge';
            if (device.status === 'active') {
                statusBadge.classList.add('bg-success');
            } else if (device.status === 'warning') {
                statusBadge.classList.add('bg-warning');
            } else {
                statusBadge.classList.add('bg-danger');
            }
            
            // Display parameters
            displayParameters(device);
            
            // Update simulation parameters
            updateSimulationParameters(device);
            
            // Update controller availability
            updateControllerOptions(device);
            
            // Fetch current metrics
            fetchCurrentMetrics(currentDeviceId);
            
            // Reset modified parameters
            modifiedParameters = {};
        }
        
        function displayParameters(device) {
            const container = document.getElementById('parameters-container');
            const params = device.current_config || {};
            deviceParameters = params;
            
            let html = '';
            for (const [key, value] of Object.entries(params)) {
                // Get parameter capabilities if available
                const capabilities = device.capabilities || {};
                const paramCapabilities = capabilities[key + '_range'] || {};
                
                if (typeof value === 'number') {
                    // Number parameter - use slider
                    const min = paramCapabilities.min !== undefined ? paramCapabilities.min : value - Math.abs(value * 0.5);
                    const max = paramCapabilities.max !== undefined ? paramCapabilities.max : value + Math.abs(value * 0.5);
                    const step = paramCapabilities.step !== undefined ? paramCapabilities.step : (max - min) / 100;
                    
                    html += `
                        <div class="mb-4">
                            <label class="form-label">${formatParameterName(key)}</label>
                            <input type="range" class="form-range parameter-input" 
                                id="param-${key}" 
                                data-param="${key}" 
                                min="${min}" 
                                max="${max}" 
                                step="${step}" 
                                value="${value}">
                            <div class="parameter-label">
                                <small>${min}</small>
                                <small id="value-${key}">${value}</small>
                                <small>${max}</small>
                            </div>
                        </div>
                    `;
                } else if (typeof value === 'boolean') {
                    // Boolean parameter - use switch
                    html += `
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input parameter-input" 
                                    type="checkbox" 
                                    id="param-${key}" 
                                    data-param="${key}" 
                                    ${value ? 'checked' : ''}>
                                <label class="form-check-label" for="param-${key}">${formatParameterName(key)}</label>
                            </div>
                        </div>
                    `;
                } else if (Array.isArray(paramCapabilities.options)) {
                    // Enum parameter - use select
                    let options = '';
                    paramCapabilities.options.forEach(option => {
                        options += `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`;
                    });
                    
                    html += `
                        <div class="mb-4">
                            <label class="form-label" for="param-${key}">${formatParameterName(key)}</label>
                            <select class="form-select parameter-input" id="param-${key}" data-param="${key}">
                                ${options}
                            </select>
                        </div>
                    `;
                } else {
                    // Text parameter - use input
                    html += `
                        <div class="mb-4">
                            <label class="form-label" for="param-${key}">${formatParameterName(key)}</label>
                            <input type="text" class="form-control parameter-input" id="param-${key}" data-param="${key}" value="${value}">
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
            
            // Add event listeners to parameter inputs
            document.querySelectorAll('.parameter-input').forEach(input => {
                input.addEventListener('input', function() {
                    const param = this.getAttribute('data-param');
                    let value;
                    
                    if (this.type === 'checkbox') {
                        value = this.checked;
                    } else if (this.type === 'range') {
                        value = parseFloat(this.value);
                        document.getElementById(`value-${param}`).textContent = value;
                    } else if (this.tagName === 'SELECT') {
                        value = this.value;
                    } else {
                        value = this.value;
                        // Try to convert to number if possible
                        if (!isNaN(value) && value.trim() !== '') {
                            value = parseFloat(value);
                        }
                    }
                    
                    modifiedParameters[param] = value;
                });
            });
        }
        
        function updateSimulationParameters(device) {
            const container = document.getElementById('simulation-parameters');
            const params = device.current_config || {};
            
            let html = '';
            for (const [key, value] of Object.entries(params)) {
                if (typeof value === 'number') {
                    // Number parameter - use slider for simulation
                    html += `
                        <div class="mb-3">
                            <label class="form-label">${formatParameterName(key)}</label>
                            <input type="range" class="form-range simulation-param" 
                                id="sim-param-${key}" 
                                data-param="${key}" 
                                min="${value * 0.5}" 
                                max="${value * 1.5}" 
                                step="${value * 0.01}" 
                                value="${value}">
                            <div class="parameter-label">
                                <small>${(value * 0.5).toFixed(2)}</small>
                                <small id="sim-value-${key}">${value}</small>
                                <small>${(value * 1.5).toFixed(2)}</small>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `
                <div class="mb-3">
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" id="enable-parameter-sweep">
                        Enable Parameter Sweep
                    </label>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners to simulation parameter inputs
            document.querySelectorAll('.simulation-param').forEach(input => {
                input.addEventListener('input', function() {
                    const param = this.getAttribute('data-param');
                    const value = parseFloat(this.value);
                    document.getElementById(`sim-value-${param}`).textContent = value.toFixed(2);
                });
            });
            
            // Parameter sweep button
            document.getElementById('enable-parameter-sweep').addEventListener('change', function() {
                if (this.checked) {
                    showParameterSweepModal();
                }
            });
        }
        
        function updateControllerOptions(device) {
            // Populate the parameter sweep select
            const sweepSelect = document.getElementById('sweep-parameter-select');
            sweepSelect.innerHTML = '';
            
            const params = device.current_config || {};
            for (const [key, value] of Object.entries(params)) {
                if (typeof value === 'number') {
                    sweepSelect.innerHTML += `<option value="${key}">${formatParameterName(key)}</option>`;
                }
            }
        }
        
        function fetchCurrentMetrics(deviceId) {
            fetch(`/api/network/programmable/device/${deviceId}/metrics`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateMetricsDisplay(data.metrics);
                        
                        // Add to performance history
                        const timestamp = new Date().toLocaleTimeString();
                        performanceHistory.timestamps.push(timestamp);
                        performanceHistory.tx_power.push(data.metrics.tx_power_dbm);
                        performanceHistory.snr.push(data.metrics.snr_db);
                        performanceHistory.ber.push(data.metrics.ber);
                        performanceHistory.data_rate.push(data.metrics.data_rate_gbps);
                        
                        // Limit history length
                        if (performanceHistory.timestamps.length > 20) {
                            performanceHistory.timestamps.shift();
                            performanceHistory.tx_power.shift();
                            performanceHistory.snr.shift();
                            performanceHistory.ber.shift();
                            performanceHistory.data_rate.shift();
                        }
                        
                        // Update history chart
                        updateParameterHistoryChart();
                        updatePerformanceTrendsChart();
                    } else {
                        console.error('Failed to load metrics:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching metrics:', error);
                });
        }
        
        function updateMetricsDisplay(metrics) {
            document.getElementById('current-snr').textContent = metrics.snr_db.toFixed(2) + ' dB';
            document.getElementById('current-ber').textContent = metrics.ber.toExponential(2);
            document.getElementById('current-data-rate').textContent = metrics.data_rate_gbps.toFixed(2) + ' Gbps';
            document.getElementById('current-power').textContent = metrics.tx_power_dbm.toFixed(2) + ' dBm';
        }
        
        function initializeCharts() {
            // Parameter history chart
            const paramHistoryCtx = document.getElementById('parameter-history-chart').getContext('2d');
            parameterHistoryChart = new Chart(paramHistoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Value',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Performance trends chart
            const performanceTrendsCtx = document.getElementById('performance-trends-chart').getContext('2d');
            performanceTrendsChart = new Chart(performanceTrendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'SNR (dB)',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'transparent',
                            tension: 0.2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'BER',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            tension: 0.2,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Data Rate (Gbps)',
                            data: [],
                            borderColor: '#0d6efd',
                            backgroundColor: 'transparent',
                            tension: 0.2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'logarithmic',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Sweep results chart
            const sweepResultsCtx = document.getElementById('sweep-results-chart').getContext('2d');
            sweepResultsChart = new Chart(sweepResultsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'SNR (dB)',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'transparent',
                            tension: 0.2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'BER',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            tension: 0.2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'logarithmic',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateParameterHistoryChart() {
            const selectedParam = document.getElementById('parameter-history-select').value;
            
            parameterHistoryChart.data.labels = performanceHistory.timestamps;
            parameterHistoryChart.data.datasets[0].data = performanceHistory[selectedParam];
            parameterHistoryChart.data.datasets[0].label = formatParameterName(selectedParam);
            
            parameterHistoryChart.update();
        }
        
        function updatePerformanceTrendsChart() {
            performanceTrendsChart.data.labels = performanceHistory.timestamps;
            performanceTrendsChart.data.datasets[0].data = performanceHistory.snr;
            performanceTrendsChart.data.datasets[1].data = performanceHistory.ber;
            performanceTrendsChart.data.datasets[2].data = performanceHistory.data_rate;
            
            performanceTrendsChart.update();
        }
        
        function showParameterSweepModal() {
            const modal = new bootstrap.Modal(document.getElementById('parameter-sweep-modal'));
            modal.show();
        }
        
        function setupEventListeners() {
            // Refresh devices button
            document.getElementById('refresh-devices-btn').addEventListener('click', fetchDevices);
            
            // Scan network button
            document.getElementById('scan-network-btn').addEventListener('click', fetchDevices);
            
            // Apply parameters button
            document.getElementById('apply-parameters-btn').addEventListener('click', applyParameters);
            
            // Reset parameters button
            document.getElementById('reset-parameters-btn').addEventListener('click', resetParameters);
            
            // Run simulation button
            document.getElementById('run-simulation-btn').addEventListener('click', runSimulation);
            
            // Parameter history select
            document.getElementById('parameter-history-select').addEventListener('change', updateParameterHistoryChart);
            
            // Refresh metrics button
            document.getElementById('refresh-metrics-btn').addEventListener('click', function() {
                if (currentDeviceId) {
                    fetchCurrentMetrics(currentDeviceId);
                }
            });
            
            // Controller sliders
            document.getElementById('snr-interval').addEventListener('input', function() {
                document.getElementById('snr-interval-value').textContent = this.value + 's';
            });
            document.getElementById('mod-interval').addEventListener('input', function() {
                document.getElementById('mod-interval-value').textContent = this.value + 's';
            });
            document.getElementById('mod-margin').addEventListener('input', function() {
                document.getElementById('mod-margin-value').textContent = this.value + ' dB';
            });
            document.getElementById('power-interval').addEventListener('input', function() {
                document.getElementById('power-interval-value').textContent = this.value + 's';
            });
            document.getElementById('min-snr').addEventListener('input', function() {
                document.getElementById('min-snr-value').textContent = this.value + ' dB';
            });
            
            // Start controller buttons
            document.getElementById('start-snr-optimizer').addEventListener('click', function() {
                startController('snr_optimizer', {
                    update_interval: parseInt(document.getElementById('snr-interval').value)
                });
            });
            document.getElementById('start-mod-adaptor').addEventListener('click', function() {
                startController('modulation_adaptor', {
                    update_interval: parseInt(document.getElementById('mod-interval').value),
                    snr_margin: parseFloat(document.getElementById('mod-margin').value)
                });
            });
            document.getElementById('start-power-optimizer').addEventListener('click', function() {
                startController('power_optimizer', {
                    update_interval: parseInt(document.getElementById('power-interval').value),
                    min_snr: parseFloat(document.getElementById('min-snr').value)
                });
            });
            
            // Run parameter sweep button
            document.getElementById('run-sweep-btn').addEventListener('click', runParameterSweep);
        }
        
        function applyParameters() {
            if (!currentDeviceId || Object.keys(modifiedParameters).length === 0) {
                return;
            }
        }
    </script>
</body>
</html>